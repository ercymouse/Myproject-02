<!DOCTYPE html>
<html lang="en">
<head>
  <script type="text/javascript">window.$crisp=[];window.CRISP_WEBSITE_ID="22db923e-251f-4b1e-92ee-411f746f75db";(function(){d=document;s=d.createElement("script");s.src="https://client.crisp.chat/l.js";s.async=1;d.getElementsByTagName("head")[0].appendChild(s);})();</script>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2103/2103665.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Posts of Study</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f2f5;
      color: #333;
      background-color: #000000d1;
    }

    header:after {
      content: '';
      display: block;
      height: 44px;
      margin-left: -22px;
      position: absolute;
      left: 50%;
      bottom: -22px;
      width: 44px;
      border-radius: 50%;
    }

    header {
      box-shadow: 0 4px 8px #9f2d2de8;
      font-family: 'Courier New', Courier, monospace;
      background-color: #32363ec4;
      color: #fff;
      padding: 15px;
      text-align: center;
      font-size: 24px;
      background-color: #333;
      color: #fff;
      padding: 15px;
      text-align: center;
      position: sticky;
      top: 0;
      width: 100%;
      z-index: 100;
    }

    #postContainer {
      width: 60%;
      margin: 20px auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    textarea {
      background-color: rgba(0, 0, 0, 0.66);
      color: white;
    }

    input {
      border: #977474;
      width: 380px;
    }

    #postForm {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #postForm label {
      font-size: 16px;
      margin-bottom: 5px;
    }

    #postList {
      margin-top: 20px;
    }

    .post {
      background-color: #fff;
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    }

    .post p {
      margin: 10px 0;
      font-size: 18px;
    }

    .comments {
      margin-top: 15px;
    }

    .comment {
      background-color: #f0f2f5;
      padding: 8px;
      margin-top: 8px;
      border-radius: 5px;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .audio-comment {
      margin-top: 8px;
    }

    #postList img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }

    button {
      background-color: #9f2d2dfa;
      color: #fff;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #00000099;
    }

    .delete-btn {
      background-color: #ff4c4c;
    }
  </style>
</head>
<body>

  <header>
    <h1>ramadan-posts of study</h1>
  </header>

  <div id="postContainer">
    <form id="postForm">
      <label for="postText">Create a new post:</label>
      <textarea id="postText" rows="4"></textarea>
      <label for="postImage">Attach an image:</label>
      <input type="file" id="postImage" accept="image/*">
      <button type="button" onclick="createPost()">Post</button>
    </form>

    <div id="postList"></div>
  </div>

  <script>
    let posts = [];

    async function createPost() {
      const postText = document.getElementById('postText').value;
      const postImageInput = document.getElementById('postImage');
      const postImage = postImageInput.files.length > 0 ? await convertImageToBase64(postImageInput.files[0]) : null;

      if (postText.trim() === '' && !postImage) {
        alert('Please enter text or attach an image.');
        return;
      }

      const postList = document.getElementById('postList');

      const postItem = document.createElement('div');
      postItem.className = 'post';

      if (postText.trim() !== '') {
        const textElement = document.createElement('p');
        textElement.textContent = postText;
        postItem.appendChild(textElement);
      }

      if (postImage) {
        const imageElement = document.createElement('img');
        imageElement.src = postImage;
        postItem.appendChild(imageElement);
      }

      const commentSection = document.createElement('div');
      commentSection.className = 'comments';
      const commentInput = document.createElement('input');
      commentInput.type = 'text';
      commentInput.placeholder = 'Add a comment...';
      const commentButton = document.createElement('button');
      commentButton.textContent = 'Comment';
      commentButton.onclick = function () {
        addComment(commentSection, commentInput.value, null, null);
      };

      commentSection.appendChild(commentInput);
      commentSection.appendChild(commentButton);

      // Audio recording feature
      const audioCommentButton = document.createElement('button');
      audioCommentButton.textContent = 'Record Audio';
      audioCommentButton.onclick = function () {
        recordAudio(commentSection, null);
      };
      commentSection.appendChild(audioCommentButton);

      postItem.appendChild(commentSection);

      postList.appendChild(postItem);

      // Clear the form
      document.getElementById('postForm').reset();

      // Save the post with base64-encoded image data
      const post = {
        text: postText,
        image: postImage,
        comments: [],
      };

      posts.push(post);
      updateLocalStorage();
    }

    function addComment(commentSection, commentText, audioBlob, commentId) {
      if (commentText.trim() !== '' || audioBlob) {
        const commentItem = document.createElement('div');
        commentItem.className = 'comment';
        commentItem.textContent = commentText
        if (audioBlob) {
          // Audio comment
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = URL.createObjectURL(audioBlob);
          audio.className = 'audio-comment';
          commentItem.appendChild(audio);

          // Delete button for audio comment
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.className = 'delete-btn';
          deleteBtn.onclick = function () {
            deleteComment(commentItem, audioBlob, commentId);
          };
          commentItem.appendChild(deleteBtn);
        }

        commentSection.appendChild(commentItem);

        // Save the comment to the post's data
        const postId = commentSection.closest('.post').dataset.postId;
        const post = posts.find(post => post.id === postId);
        if (post) {
          const commentData = {
            text: commentText,
            audioBlob: audioBlob,
          };
          if (commentId !== null) {
            post.comments[commentId] = commentData;
          } else {
            post.comments.push(commentData);
          }
          updateLocalStorage();
        }
      }
    }

    function deleteComment(commentItem, audioBlob, commentId) {
      // Remove the comment from the UI
      commentItem.remove();

      // Remove the comment from the post's data
      const postId = commentItem.closest('.post').dataset.postId;
      const post = posts.find(post => post.id === postId);
      if (post) {
        if (commentId !== null) {
          post.comments.splice(commentId, 1);
        } else {
          post.comments = post.comments.filter(comment => comment.audioBlob !== audioBlob);
        }
        updateLocalStorage();
      }
    }

    function recordAudio(commentSection, commentId) {
      const constraints = { audio: true };

      navigator.mediaDevices.getUserMedia(constraints)
        .then(function (stream) {
          const mediaRecorder = new MediaRecorder(stream);
          const audioChunks = [];

          mediaRecorder.ondataavailable = function (event) {
            if (event.data.size > 0) {
              audioChunks.push(event.data);
            }
          };

          mediaRecorder.onstop = function () {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            addComment(commentSection, '', audioBlob, commentId);
          };

          // Start recording
          mediaRecorder.start();

          // Stop recording after 10 seconds
          setTimeout(function () {
            mediaRecorder.stop();
            stream.getTracks().forEach(track => track.stop());
          }, 10000); // 10 seconds
        })
        .catch(function (err) {
          console.error('Error accessing microphone:', err);
        });
    }

    function updateLocalStorage() {
      localStorage.setItem('posts', JSON.stringify(posts));
    }

    function loadPosts() {
      const storedPosts = localStorage.getItem('posts');
      if (storedPosts) {
        posts = JSON.parse(storedPosts);

        const postList = document.getElementById('postList');
        postList.innerHTML = '';

        posts.forEach((post, index) => {
          const postItem = document.createElement('div');
          postItem.className = 'post';
          postItem.dataset.postId = index;

          if (post.text.trim() !== '') {
            const textElement = document.createElement('p');
            textElement.textContent = post.text;
            postItem.appendChild(textElement);
          }

          if (post.image) {
            const imageElement = document.createElement('img');
            imageElement.src = post.image;
            postItem.appendChild(imageElement);
          }

          const commentSection = document.createElement('div');
          commentSection.className = 'comments';

          post.comments.forEach((comment, commentIndex) => {
            if (comment.audioBlob) {
              addComment(commentSection, '', comment.audioBlob, commentIndex);
            } else {
              addComment(commentSection, comment.text, null, commentIndex);
            }
          });

          const commentInput = document.createElement('input');
          commentInput.type = 'text';
          commentInput.placeholder = 'add an answer...';

          const commentButton = document.createElement('button');
          commentButton.textContent = 'answered';
          commentButton.onclick = function () {
            addComment(commentSection, commentInput.value, null, null);
            post.comments.push({
              text: commentInput.value,
              audioBlob: null,
            });
            updateLocalStorage();
          };

          commentSection.appendChild(commentInput);
          commentSection.appendChild(commentButton);

          // Audio recording button
          const audioCommentButton = document.createElement('button');
          audioCommentButton.textContent = 'Record Audio';
          audioCommentButton.onclick = function () {
            recordAudio(commentSection, null);
          };
          commentSection.appendChild(audioCommentButton);

          postItem.appendChild(commentSection);

          postList.appendChild(postItem);
        });
      }
    }

    // Load stored posts on page load
    loadPosts();

    // Add a function to convert the image to base64
    async function convertImageToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function (e) {
          resolve(e.target.result);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>

</body>
</html>
